%***************************************
%Author: Chaoqun Wang
%Date: 2019-10-15
%***************************************
%% ?????
clc
clear all; close all;
x_I=1; y_I=1;           % ?????
x_G=700; y_G=700;       % ??????????????
Thr=50;                 % ???????
Delta= 30;              % ??????

%% ?????
T.v(1).x = x_I;         % T????????v??????????????T???
T.v(1).y = y_I; 
T.v(1).xPrev = x_I;     % ??????????????
T.v(1).yPrev = y_I;
T.v(1).dist=0;          % ????????????????????
T.v(1).indPrev = 0;     %

Nodes = [x_I,y_I];     % only save the coordinates of nodes in the tree
%% ??????????
figure(1);
ImpRgb=imread('newmap.png');
Imp=rgb2gray(ImpRgb);
imshow(Imp)
xL=size(Imp,2);%??x???
yL=size(Imp,1);%??y???
hold on
plot(x_I, y_I, 'ro', 'MarkerSize',10, 'MarkerFaceColor','r');
plot(x_G, y_G, 'go', 'MarkerSize',10, 'MarkerFaceColor','g');% ????????
count=1;
bFind = false;

for iter = 1:3000
    x_rand=[];
    %Step 1: ???????????x_rand
    %?????x_rand(1),x_rand(2)????????????
    x_rand(1) = randi([0, xL],1);
    x_rand(2) = randi([0, yL],1);
    
    x_near=[];
    %Step 2: ??????????????x_near 
    %???x_near????T?
    dis = (Nodes(:,1) - x_rand(1)).*(Nodes(:,1) - x_rand(1)) ...
           + (Nodes(:,2) - x_rand(2)).*(Nodes(:,2) - x_rand(2));
    [dis_min, index] = min(dis);
    x_near(1) = Nodes(index, 1);
    x_near(2) = Nodes(index, 2);
    
    x_new=[];
    %Step 3: ????x_new??
    %???????????Delta
    dis_min = sqrt(dis_min);
    delta_x = (x_rand(1) - x_near(1)) * Delta/dis_min;
    delta_y = (x_rand(2) - x_near(2)) * Delta/dis_min;
    x_new(1) = x_near(1) + delta_x;
    x_new(2) = x_near(2) + delta_y;
    
    %???????collision-free
    if ~collisionChecking(x_near,x_new,Imp) 
       continue;
    end
    count=count+1;
    
    %Step 4: ?x_new???T 
    %??????x_new?????x_near
    T.v(count).x = x_new(1);         
    T.v(count).y = x_new(2); 
    T.v(count).xPrev = x_near(1);   
    T.v(count).yPrev = x_near(2);
    T.v(count).dist  = Delta;          
    T.v(count).indPrev = index;    
    Nodes = [Nodes; x_new(1), x_new(2)];
    
    %Step 5:??????????? 
    %????????????Thr????????????????Thr??????for??    
    %Step 6:?x_near?x_new????????
    %?? 1???plot?????????????????????????plot?????hold on??
    %?? 2??????????for???????x_near?x_new????????
    plot(x_new(1), x_new(2),'ro', 'MarkerSize',3, 'MarkerFaceColor','r');
    plot([x_near(1),x_new(1)],[x_near(2),x_new(2)], 'r','LineWidth',1);

    if (abs(pdist([x_new(1),x_new(2);x_G,y_G],'euclidean')) <= Thr)
        bFind = true; 
        break; 
    end
    
    pause(0.05); %???????RRT????????
end
%% ???????????
if bFind
    path.pos(1).x = x_G; path.pos(1).y = y_G;
    path.pos(2).x = T.v(end).x; path.pos(2).y = T.v(end).y;
    pathIndex = T.v(end).indPrev; % ??????
    j=0;
    while 1
        path.pos(j+3).x = T.v(pathIndex).x;
        path.pos(j+3).y = T.v(pathIndex).y;
        pathIndex = T.v(pathIndex).indPrev;
        if pathIndex == 1
            break
        end
        j=j+1;
    end  % ????????
    path.pos(end+1).x = x_I; path.pos(end).y = y_I; % ??????
    for j = 2:length(path.pos)
        plot([path.pos(j).x; path.pos(j-1).x;], [path.pos(j).y; path.pos(j-1).y], 'b', 'Linewidth', 3);
    end
else
    disp('Error, no path found!');
end
